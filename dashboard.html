// --- 1. Firebase Configuration (ใส่ข้อมูลของคุณที่นี่) ---
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

// Global Variables
let loanChart;
const loanModal = document.getElementById("loanModal");
const openModalBtn = document.getElementById("openModalBtn");
const closeModal = document.querySelector(".close");
const loanForm = document.getElementById("loanForm");

// --- 2. Modal Logic ---
openModalBtn.onclick = () => loanModal.style.display = "block";
closeModal.onclick = () => loanModal.style.display = "none";
window.onclick = (e) => { if (e.target == loanModal) loanModal.style.display = "none"; };

// --- 3. ดึงข้อมูลและอัปเดต Dashboard ---
async function loadDashboardData(startDate = null, endDate = null) {
    let query = db.collection("loans");

    // การกรองข้อมูล
    if (startDate && endDate) {
        query = query.where("loanDate", ">=", startDate).where("loanDate", "<=", endDate);
    }

    try {
        // แนะนำ: หากหน้าจอค้างหรือไม่แสดงผล ให้กด F12 ดู Console หากเจอลิงก์ให้สร้าง Index ให้กดสร้างทันที
        const snapshot = await query.orderBy("loanDate", "asc").get();
        
        let totalPrincipal = 0;
        let totalPaid = 0;
        let monthlyData = {};

        if (snapshot.empty) {
            console.log("No data found.");
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const principal = parseFloat(data.principal) || 0;
            const interest = parseFloat(data.interest) || 0;
            const loanDate = data.loanDate || "";

            totalPrincipal += principal;

            if (data.status === "คืนแล้ว") {
                totalPaid += (principal + interest);
            }

            // จัดกลุ่มยอดกู้รายเดือนสำหรับกราฟ
            if (loanDate) {
                const monthYear = loanDate.substring(0, 7); // YYYY-MM
                monthlyData[monthYear] = (monthlyData[monthYear] || 0) + principal;
            }
        });

        // อัปเดตตัวเลขบนหน้าเว็บ
        document.getElementById("totalLoans").innerText = totalPrincipal.toLocaleString() + " ฿";
        document.getElementById("paidAmount").innerText = totalPaid.toLocaleString() + " ฿";

        renderChart(monthlyData);

    } catch (error) {
        console.error("Firebase Error:", error);
        // หากพบ Error เรื่อง Index ระบบจะแจ้งลิงก์ในหน้า Console
    }
}

// --- 4. ฟังก์ชันจัดการกราฟ ---
function renderChart(stats) {
    const ctx = document.getElementById('loanChart').getContext('2d');
    
    if (loanChart) {
        loanChart.destroy(); // ต้องลบกราฟเก่าออกก่อนวาดใหม่เมื่อมีการ Filter
    }

    const labels = Object.keys(stats);
    const values = Object.values(stats);

    loanChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'ยอดปล่อยกู้ใหม่ (บาท)',
                data: values,
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: '#2980b9',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                x: { grid: { display: false } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// --- 5. บันทึกข้อมูล ---
loanForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const saveBtn = document.getElementById("saveBtn");
    saveBtn.disabled = true;
    saveBtn.innerText = "กำลังบันทึก...";

    const newEntry = {
        nickname: document.getElementById("nickname").value,
        nameSurname: document.getElementById("nameSurname").value,
        idCard: document.getElementById("idCard").value,
        telephone: document.getElementById("telephone").value,
        loanDate: document.getElementById("loanDate").value,
        principal: parseFloat(document.getElementById("principal").value),
        interest: parseFloat(document.getElementById("interest").value || 0),
        status: document.getElementById("status").value,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection("loans").add(newEntry);
        alert("บันทึกข้อมูลเรียบร้อยแล้ว!");
        loanForm.reset();
        loanModal.style.display = "none";
        loadDashboardData(); // รีโหลดข้อมูลใหม่
    } catch (err) {
        alert("เกิดข้อผิดพลาด: " + err.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerText = "บันทึกข้อมูล";
    }
});

// --- 6. ปุ่ม Filter และ Reset ---
document.getElementById("filterBtn").onclick = () => {
    const sDate = document.getElementById("startDate").value;
    const eDate = document.getElementById("endDate").value;
    if (sDate && eDate) {
        loadDashboardData(sDate, eDate);
    } else {
        alert("กรุณาระบุวันที่ให้ครบทั้งสองช่อง");
    }
};

document.getElementById("resetBtn").onclick = () => {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    loadDashboardData();
};

// โหลดครั้งแรก
window.onload = () => loadDashboardData();
