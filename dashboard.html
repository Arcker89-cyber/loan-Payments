// --- 1. Firebase Configuration (เปลี่ยนเป็นของคุณ) ---
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

// Variables
let loanChart;
const loanModal = document.getElementById("loanModal");
const openModalBtn = document.getElementById("openModalBtn");
const closeModal = document.querySelector(".close");
const loanForm = document.getElementById("loanForm");

// --- 2. Modal Controls ---
openModalBtn.onclick = () => loanModal.style.display = "block";
closeModal.onclick = () => loanModal.style.display = "none";
window.onclick = (e) => { if (e.target == loanModal) loanModal.style.display = "none"; };

// --- 3. ดึงข้อมูลและอัปเดต Dashboard ---
async function loadDashboardData(startDate = null, endDate = null) {
    let query = db.collection("loans");

    if (startDate && endDate) {
        query = query.where("loanDate", ">=", startDate).where("loanDate", "<=", endDate);
    }

    try {
        const snapshot = await query.orderBy("loanDate", "asc").get();
        let totalPrincipal = 0;
        let totalPaid = 0;
        let monthlyStats = {};

        snapshot.forEach(doc => {
            const data = doc.data();
            const principal = parseFloat(data.principal) || 0;
            const interest = parseFloat(data.interest) || 0;

            // 1. คำนวณเงินต้นรวมทั้งหมดที่มีในระบบ (ตาม Filter)
            totalPrincipal += principal;

            // 2. คำนวณยอดที่ปิดยอดไปแล้ว (ต้น + ดอก)
            if (data.status === "คืนแล้ว") {
                totalPaid += (principal + interest);
            }

            // 3. เตรียมข้อมูลกราฟ (รายเดือน)
            const month = data.loanDate.substring(0, 7); // เก็บค่า YYYY-MM
            monthlyStats[month] = (monthlyStats[month] || 0) + principal;
        });

        // อัปเดต UI
        document.getElementById("totalLoans").innerText = totalPrincipal.toLocaleString() + " ฿";
        document.getElementById("paidAmount").innerText = totalPaid.toLocaleString() + " ฿";

        renderChart(monthlyStats);

    } catch (error) {
        console.error("Error loading data: ", error);
    }
}

// --- 4. ฟังก์ชันจัดการกราฟ ---
function renderChart(monthlyData) {
    const ctx = document.getElementById('loanChart').getContext('2d');
    
    if (loanChart) loanChart.destroy();

    loanChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(monthlyData),
            datasets: [{
                label: 'ยอดปล่อยกู้ (เงินต้น)',
                data: Object.values(monthlyData),
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// --- 5. บันทึกข้อมูลใหม่ ---
loanForm.onsubmit = async (e) => {
    e.preventDefault();
    
    const submitBtn = loanForm.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerText = "กำลังบันทึก...";

    const formData = {
        nickname: document.getElementById("nickname").value,
        nameSurname: document.getElementById("nameSurname").value,
        idCard: document.getElementById("idCard").value,
        telephone: document.getElementById("telephone").value,
        loanDate: document.getElementById("loanDate").value,
        principal: parseFloat(document.getElementById("principal").value),
        interest: parseFloat(document.getElementById("interest").value || 0),
        status: document.getElementById("status").value,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection("loans").add(formData);
        alert("บันทึกข้อมูลเรียบร้อย!");
        loanForm.reset();
        loanModal.style.display = "none";
        loadDashboardData(); // Refresh ข้อมูล
    } catch (error) {
        alert("เกิดข้อผิดพลาด: " + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = "บันทึกข้อมูล";
    }
};

// --- 6. ระบบ Filter ---
document.getElementById("filterBtn").onclick = () => {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    if (start && end) {
        loadDashboardData(start, end);
    } else {
        alert("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด");
    }
};

document.getElementById("resetBtn").onclick = () => {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    loadDashboardData();
};

// โหลดข้อมูลครั้งแรกเมื่อเปิดหน้า
window.onload = loadDashboardData;
